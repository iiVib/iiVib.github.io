<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø´Ø®ØµÙŠØ§Øª</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="game-screen">
        <div class="game-header-top">
            <div class="game-info">
                <p id="currentRole"></p>
                <p id="gameCodeDisplay"></p>
            </div>
            <button class="exit-btn" onclick="exitGame()">Ø®Ø±ÙˆØ¬ âŒ</button>
        </div>

        <div class="container">
            <div class="header">
                <h1>âš¡ Ù„Ø¹Ø¨Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø®ØµÙŠØ§Øª âš¡</h1>
                <p id="gameStatus">ğŸ® Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¬Ø§Ù‡Ø²Ø©!</p>
            </div>

            <div class="game-wrapper">
                <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø®ØµÙŠØ§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© -->
                <div class="characters-grid" id="mainGrid"></div>

                <!-- Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„ -->
                <div class="player-section player1">
                    <div class="player-title">ğŸ‘¤ Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„</div>
                    <div class="characters-grid" id="player1Display"></div>
                    <button class="reset-btn" onclick="resetPlayer(1)">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
                </div>

                <!-- Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ -->
                <div class="player-section player2">
                    <div class="player-title">ğŸ‘¥ Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ</div>
                    <div class="characters-grid" id="player2Display"></div>
                    <button class="reset-btn" onclick="resetPlayer(2)">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
                </div>
            </div>

            <div class="info">
                <p id="instructionText">âœ¨ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø®ØµÙŠØ© Ù„ØªØ­Ø¯ÙŠØ¯Ù‡Ø§ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</p>
            </div>
        </div>
    </div>

    <script>
        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
        const characters = [
            { name: 'Yuji Itadori', image: 'images/1.jfif' },
            { name: 'Megumi Fushiguro', image: 'images/2.jfif' },
            { name: 'Nobara Kugisaki', image: 'images/3.jfif' },
            { name: 'Satoru Gojo', image: 'images/4.jfif' },
            { name: 'Ryomen Sukuna', image: 'images/5.jfif' },
            { name: 'Kento Nanami', image: 'images/6.jfif' },
            { name: 'Maki Zenin', image: 'images/7.jfif' },
            { name: 'Toge Inumaki', image: 'images/8.jfif' },
            { name: 'Panda', image: 'images/9.jfif' },
            { name: 'Yuta Okkotsu', image: 'images/10.jfif' },
            { name: 'Suguru Geto', image: 'images/11.jfif' },
            { name: 'Mahito', image: 'images/12.jfif' },
            { name: 'Jogo', image: 'images/13.jfif' },
            { name: 'Hanami', image: 'images/14.jfif' },
            { name: 'Dagon', image: 'images/15.jfif' },
            { name: 'Aoi Todo', image: 'images/16.jfif' },
            { name: 'Mai Zenin', image: 'images/17.jfif' },
            { name: 'Kasumi Miwa', image: 'images/18.jfif' },
            { name: 'Kokichi Muta', image: 'images/19.jfif' },
            { name: 'Noritoshi Kamo', image: 'images/20.jfif' },
            { name: 'Momo Nishimiya', image: 'images/21.jfif' },
            { name: 'Shoko Ieiri', image: 'images/22.jfif' },
            { name: 'Kiyotaka Ijichi', image: 'images/23.jfif' },
            { name: 'Yoshinobu Gakuganji', image: 'images/24.jfif' },
            { name: 'Mei Mei', image: 'images/25.jfif' },
            { name: 'Ui Ui', image: 'images/26.jfif' },
            { name: 'Choso', image: 'images/27.jfif' },
            { name: 'Eso', image: 'images/28.jfif' },
            { name: 'Kechizu', image: 'images/29.jfif' },
            { name: 'Toji Fushiguro', image: 'images/30.jfif' },
            { name: 'Naobito Zenin', image: 'images/31.jfif' },
            { name: 'Naoya Zenin', image: 'images/32.jfif' },
            { name: 'Yuki Tsukumo', image: 'images/33.jfif' },
            { name: 'Tengen', image: 'images/34.jfif' },
            { name: 'Masamichi Yaga', image: 'images/35.jfif' },
            { name: 'Arata Nitta', image: 'images/36.jfif' },
            { name: 'Junpei Yoshino', image: 'images/37.jfif' },
            { name: 'Kenjaku', image: 'images/38.jfif' },
            { name: 'Uraume', image: 'images/39.jfif' },
            { name: 'Haruta Shigemo', image: 'images/40.jfif' },
            { name: 'Juzo Kumiya', image: 'images/41.jfif' },
            { name: 'Jiro Awasaka', image: 'images/42.jfif' },
            { name: 'Ogami', image: 'images/43.jfif' },
            { name: 'Rika Orimoto', image: 'images/44.jfif' },
            { name: 'Hiromi Higuruma', image: 'images/45.jfif' },
            { name: 'Hajime Kashimo', image: 'images/46.jfif' },
            { name: 'Ryu Ishigori', image: 'images/47.jfif' },
            { name: 'Takako Uro', image: 'images/48.jfif' },
            { name: 'Fumihiko Takaba', image: 'images/49.jfif' },
            { name: 'Tsumiki Fushiguro', image: 'images/50.jfif' }
        ];

        let selectedPlayer1 = new Set();
        let selectedPlayer2 = new Set();
        let currentGameCode = null;
        let currentRole = null;
        let syncInterval = null;

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        function loadGameData() {
            currentGameCode = sessionStorage.getItem('gameCode');
            currentRole = parseInt(sessionStorage.getItem('playerRole'));

            if (!currentGameCode || !currentRole) {
                alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¹ÙˆØ¯Ø© ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯.');
                window.location.href = 'login.html';
                return;
            }

            // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨
            const roleText = currentRole === 1 ? 'Ø£Ù†Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„ ğŸ‘¤' : 'Ø£Ù†Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ ğŸ‘¥';
            document.getElementById('currentRole').textContent = roleText;
            document.getElementById('gameCodeDisplay').textContent = `ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©: ${currentGameCode}`;

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠØŒ Ø§Ù†ØªØ¸Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„
            if (currentRole === 2) {
                document.getElementById('instructionText').textContent = 'â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„...';
            }

            initGame();
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
        function updateFromStorage() {
            const rooms = JSON.parse(localStorage.getItem('activeRooms') || '{}');
            const room = rooms[currentGameCode];
            
            if (room) {
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©)
                if (room.player1 && room.player1.selected && currentRole === 2) {
                    selectedPlayer1 = new Set(room.player1.selected);
                    updateDisplay();
                }
                if (room.player2 && room.player2.selected && currentRole === 1) {
                    selectedPlayer2 = new Set(room.player2.selected);
                    updateDisplay();
                }
            }
        }

        // Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª
        function saveSelections() {
            const rooms = JSON.parse(localStorage.getItem('activeRooms') || '{}');
            if (!rooms[currentGameCode]) {
                rooms[currentGameCode] = { code: currentGameCode };
            }

            if (currentRole === 1) {
                if (!rooms[currentGameCode].player1) {
                    rooms[currentGameCode].player1 = {};
                }
                rooms[currentGameCode].player1.selected = Array.from(selectedPlayer1);
            } else {
                if (!rooms[currentGameCode].player2) {
                    rooms[currentGameCode].player2 = {};
                }
                rooms[currentGameCode].player2.selected = Array.from(selectedPlayer2);
            }

            localStorage.setItem('activeRooms', JSON.stringify(rooms));
        }

        // Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨Ø©
        function exitGame() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù„Ø¹Ø¨Ø©ØŸ')) {
                if (syncInterval) {
                    clearInterval(syncInterval);
                }
                const rooms = JSON.parse(localStorage.getItem('activeRooms') || '{}');
                delete rooms[currentGameCode];
                localStorage.setItem('activeRooms', JSON.stringify(rooms));
                sessionStorage.clear();
                window.location.href = 'login.html';
            }
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©
        function initGame() {
            renderMainGrid();
        }

        function renderMainGrid() {
            const grid = document.getElementById('mainGrid');
            grid.innerHTML = '';

            characters.forEach((char, index) => {
                const div = document.createElement('div');
                div.className = 'character';

                div.innerHTML = `
                    <img src="${char.image}" alt="${char.name}" onerror="this.src='https://via.placeholder.com/120/1a1a2e/FFFFFF?text=${encodeURIComponent(char.name)}'">
                    <div class="character-name">${char.name}</div>
                `;

                div.onclick = () => {
                    if (currentRole === 1) {
                        if (selectedPlayer1.has(index)) {
                            selectedPlayer1.delete(index);
                        } else {
                            selectedPlayer1.add(index);
                        }
                        saveSelections();
                    } else if (currentRole === 2) {
                        if (selectedPlayer2.has(index)) {
                            selectedPlayer2.delete(index);
                        } else {
                            selectedPlayer2.add(index);
                        }
                        saveSelections();
                    }
                    updateDisplay();
                };

                grid.appendChild(div);
            });

            updateDisplay();
        }

        function updateDisplay() {
            const mainGrid = document.getElementById('mainGrid');
            mainGrid.querySelectorAll('.character').forEach((char, index) => {
                const isSelected = (currentRole === 1 && selectedPlayer1.has(index)) || 
                                  (currentRole === 2 && selectedPlayer2.has(index));
                
                if (isSelected) {
                    char.classList.add('selected');
                } else {
                    char.classList.remove('selected');
                }
            });

            // Ø¹Ø±Ø¶ Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„ ÙÙ‚Ø· (Ù„Ø§ ÙŠØ±Ù‰ Ø§Ù„Ù…ØªÙ„Ù‚ÙŠ)
            const player1Display = document.getElementById('player1Display');
            player1Display.innerHTML = '';
            if (currentRole === 1) {
                selectedPlayer1.forEach(index => {
                    const char = characters[index];
                    const div = document.createElement('div');
                    div.className = 'character';
                    div.innerHTML = `
                        <img src="${char.image}" alt="${char.name}" onerror="this.src='https://via.placeholder.com/120/FF3D3D/FFFFFF?text=${encodeURIComponent(char.name)}'">
                        <div class="character-name">${char.name}</div>
                    `;
                    player1Display.appendChild(div);
                });
            }

            // Ø¹Ø±Ø¶ Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ ÙÙ‚Ø· (Ù„Ø§ ÙŠØ±Ù‰ Ø§Ù„Ù…ØªÙ„Ù‚ÙŠ)
            const player2Display = document.getElementById('player2Display');
            player2Display.innerHTML = '';
            if (currentRole === 2) {
                selectedPlayer2.forEach(index => {
                    const char = characters[index];
                    const div = document.createElement('div');
                    div.className = 'character';
                    div.innerHTML = `
                        <img src="${char.image}" alt="${char.name}" onerror="this.src='https://via.placeholder.com/120/00D4FF/FFFFFF?text=${encodeURIComponent(char.name)}'">
                        <div class="character-name">${char.name}</div>
                    `;
                    player2Display.appendChild(div);
                });
            }
        }

        function resetPlayer(playerNum) {
            if (playerNum === 1 && currentRole === 1) {
                selectedPlayer1.clear();
                saveSelections();
            } else if (playerNum === 2 && currentRole === 2) {
                selectedPlayer2.clear();
                saveSelections();
            }
            renderMainGrid();
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        loadGameData();

        // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        syncInterval = setInterval(() => {
            updateFromStorage();
        }, 1000);

        // ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('beforeunload', () => {
            if (syncInterval) {
                clearInterval(syncInterval);
            }
        });
    </script>
</body>
</html>
